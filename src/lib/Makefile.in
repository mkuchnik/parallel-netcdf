#
# Copyright (C) 2012, Northwestern University and Argonne National Laboratory
# See COPYRIGHT notice in top-level directory.
#
# $Id$
#
# @configure_input@

srcdir = @srcdir@
VPATH  = @srcdir@

# generated by configure, so it's in the build dir, not srcdirr
include ../../macros.make

# For VPATH build:
# Add . into search path because ./pnetcdf.h and ./ncconfig.h are created at
# the configure time in this folder and they are included by many C source
# files in this folder.
# Add $(srcdir) into search path because those C files created from their m4
# source files at the configure time include some header files in $(srcdir).
INCLUDES = -I. -I$(srcdir)

LIBRARY  = libpnetcdf.a
HEADER   = pnetcdf.h
PKGCONFIG = pnetcdf.pc

M4_HEADERS = ncx_h.m4

M4_SRCS   = getput.m4 \
            i_getput.m4 \
            bput.m4 \
            ncx.m4 \
            m_getput_varx.m4 \
            varn.m4 \
            i_varn.m4 \
            attr.m4 \
            convert_swap.m4

HEADER_SRCS = fbits.h \
              nc.h \
              nctypes.h \
              ncio.h \
              rnd.h \
              ncmpidtype.h \
              macro.h \
              utf8proc_data.h \
              utf8proc.h

LIB_CSRCS = mpinetcdf.c \
            header.c \
            mpincio.c \
            dim.c \
            error.c \
            nc.c \
            string.c \
            var.c \
            ncmpidtype.c \
            filetype.c \
            nonblocking.c   \
            malloc.c \
            utf8proc.c \
            vard.c \
            fill.c \
            util.c \
            hash_func.c

ifeq (@enable_subfiling@, yes)
LIB_CSRCS   += subfile.c
HEADER_SRCS += subfile.h
endif

PACKING_LIST = $(LIB_CSRCS) \
               $(M4_HEADERS) \
               $(M4_SRCS) \
               $(HEADER_SRCS) \
               pnetcdf.h.in \
               depend \
               Makefile.in \
               pnetcdf.pc.in \
               ncconfig.h.in

ifeq (@enable_subfiling@, no)
PACKING_LIST += subfile.c subfile.h
endif

LIB_OBJS   = $(LIB_CSRCS:.c=.o) $(M4_SRCS:.m4=.o)

GARBAGE    = $(LIBRARY) $(M4_SRCS:.m4=.c) ncx.h

DIST_GARBAGE = ncconfig.h pnetcdf.h pnetcdf.pc

all: $(LIBRARY)

$(LIBRARY): $(LIB_OBJS)
	$(AR) $(ARFLAGS) $(LIBRARY) $(LIB_OBJS)
	$(RANLIB) $(LIBRARY)

install: $(LIBRARY)
	$(INSTALL) -d -m 755 $(LIBDIR)
	$(INSTALL_DATA) $(LIBRARY) $(LIBDIR)/$(LIBRARY)
	$(INSTALL) -d -m 755 $(INCDIR)
	$(INSTALL_DATA) $(HEADER) $(INCDIR)/$(HEADER)
	$(INSTALL) -d -m 755 $(LIBDIR)/pkgconfig
	$(INSTALL_DATA) $(PKGCONFIG) $(LIBDIR)/pkgconfig/$(PKGCONFIG)

uninstall:
	$(RM) -f $(LIBDIR)/pkgconfig/$(PKGCONFIG)
	$(RM) -f $(LIBDIR)/$(LIBRARY)
	$(RM) -f $(INCDIR)/$(HEADER)

include $(srcdir)/../../rules.make

.SUFFIXES: .ln
LINT = lint
LINT.c = $(LINT) $(LINTFLAGS) $(CPPFLAGS)
.c.ln:
	$(LINT.c) -c $<

llib-lpnetcdf.ln: $(LIB_CSRCS)
	$(LINT.c) $(LIB_CSRCS) -y -o pnetcdf

lint: llib-lpnetcdf.ln
	$(LINT.c) t_nc.c llib-lpnetcdf.ln

ncx.h: ncx_h.m4
	$(M4) $(M4FLAGS) $< >$@

include $(srcdir)/depend
