#
# Copyright (C) 2003, Northwestern University and Argonne National Laboratory
# See COPYRIGHT notice in top-level directory.
#
# $Id$
#
# @configure_input@

srcdir = @srcdir@
VPATH = @srcdir@

# generated by configure, so it's in the build dir, not srcdirr
include ../../macros.make

# For VPATH build:
# Add ../lib into search path because ../lib/pnetcdf.h is created at the
# configure time and included by all C2F_SRCS files in this folder.
# Add $(srcdir) into search path because the C2F_SRCS files created at the
# configure time in this folder all include $(srcdir)/mpinetcdf_impl.h.
INCLUDES = -I../lib -I$(srcdir)

HEADER    = ../lib/pnetcdf.h
LIBRARY   = ../lib/libpnetcdf.a
ld_netcdf = -L../lib -lpnetcdf

UTIL_SRCS = issyserrf.c \
            nfxutil.c \
            xstrerrorf.c \
            xstrerrnof.c \
            xinq_libversf.c

C2F_SRCS  = allf.c

LIB_CSRCS = $(C2F_SRCS) $(UTIL_SRCS)

LIB_FSRCS = strerrorf.f strerrnof.f inq_libversf.f

PACKING_LIST = $(LIB_FSRCS) \
	       nfconfig_inc.in \
	       pnetcdf.inc.in \
	       mpinetcdf_impl.h \
	       buildiface \
	       defs \
	       createffiles \
	       Makefile.in

LIB_OBJS = $(LIB_CSRCS:.c=.o) $(LIB_FSRCS:.f=.o)

GARBAGE	     = nfconfig.inc $(LIB_CSRCS) mpifnetcdf.h
DIST_GARBAGE = nfconfig_inc pnetcdf.inc

all: nfconfig.inc $(LIBRARY)

objs: nfconfig.inc $(LIB_OBJS)

library:
	$(AR) $(ARFLAGS) $(LIBRARY) $(LIB_OBJS)
	$(RANLIB) $(LIBRARY)

$(LIBRARY): $(LIB_OBJS)
	$(AR) $(ARFLAGS) $(LIBRARY) $(LIB_OBJS)
	$(RANLIB) $(LIBRARY)

$(LIB_CSRCS): mpifnetcdf.h

mpifnetcdf.h: defs buildiface $(HEADER)
	$(RM) -f $@
	$(srcdir)/buildiface -infile=$(HEADER) -deffile=$(srcdir)/defs > allf.c
	@touch $(LIB_CSRCS)

# Starting from 1.4.0, nfconfig.inc is only used in test/nf_test/tests.inc and
# test/nf90_test/tests.inc
#
# the sed command below is for generating a fortran-friendly header files by
# replacing C comment starter '/*' with '!' in Fortran and remove '*/'
#
nfconfig.inc: nfconfig_inc
	$(RM) -f $@
	$(SED) -e "s%/\*%!%g" -e "s%\*/%%g" $< > $@

install:
	$(INSTALL) -d -m 755 $(INCDIR)
	$(INSTALL_DATA) pnetcdf.inc $(INCDIR)

uninstall:
	$(RM) -f $(INCDIR)/pnetcdf.inc

include $(srcdir)/../../rules.make
