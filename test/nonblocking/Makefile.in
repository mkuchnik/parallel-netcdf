#
#  Copyright (C) 2012, Northwestern University and Argonne National Laboratory
#  See COPYRIGHT notice in top-level directory.
#
#  $Id$

srcdir = @srcdir@
VPATH = @srcdir@

include ../../macros.make

INCLUDES = -I$(srcdir)/../../src/lib -I../../src/lib -I$(srcdir)

ld_math  = $(MATHLIB)

C_SRCS   = mcoll_perf.c \
           test_bput.c

F_SRCS	 = mcoll_testf.F \
           test_bputf.F

C_OBJS   = $(C_SRCS:.c=.o)
F_OBJS   = $(F_SRCS:.F=.o)

F90FLAGS = -I$(srcdir)/../../src/libf -I../../src/libf

PROGS    = mcoll_perf test_bput
OBJS     = $(C_OBJS)
ifeq (@has_fortran@, yes)
PROGS   += mcoll_testf test_bputf
OBJS    += $(F_OBJS)
endif

GARBAGE         = $(PROGS)

ld_pnetcdf      = -L$(srcdir)/../../src/lib -L../../src/lib -lpnetcdf

PACKING_LIST    =  $(SRCS) \
                    Makefile.in

all: $(PROGS)

mcoll_perf: mcoll_perf.o
	$(LINK.c) -o $@ $< $(ld_pnetcdf) $(ld_math) $(LIBS)

test_bput: test_bput.o
	$(LINK.c) -o $@ $< $(ld_pnetcdf) $(ld_math) $(LIBS)

mcoll_testf.o: mcoll_testf.F
	$(COMPILE.F90) $<

mcoll_testf: mcoll_testf.o
	$(LINK.F90) -o $@ $< $(ld_pnetcdf) $(ld_math) $(LIBS)

test_bputf.o: test_bputf.F
	$(COMPILE.F90) $<

test_bputf: test_bputf.o
	$(LINK.F90) -o $@ $< $(ld_pnetcdf) $(ld_math) $(LIBS)

testing: $(PROGS)
	./mcoll_perf
	./test_bput
ifeq (@has_fortran@, yes)
	./mcoll_testf
	./test_bputf
endif

verbose_testing: $(PROGS)
	./mcoll_perf -v
	./test_bput -v
ifeq (@has_fortran@, yes)
	./mcoll_testf -v
	./test_bputf -v
endif

clean:
	$(RM) -f *.o core* $(GARBAGE) *.nc *.gcno *.gcda gmon.out

distclean: clean
	$(RM) -f Makefile
