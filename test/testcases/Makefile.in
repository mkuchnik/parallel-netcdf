#
# Copyright (C) 2003, Northwestern University and Argonne National Laboratory
# See COPYRIGHT notice in top-level directory.
#
# $Id$
#
# @configure_input@

srcdir = @srcdir@
VPATH  = @srcdir@

include ../../macros.make

INCLUDES  = -I../../src/lib -I$(srcdir)/../common
FPPFLAGS += -I../../src/libf @FC_MODINC@../../src/libf90
LDFLAGS  += -L../../src/lib
LIBS     += -lpnetcdf

NCMPIGEN = ../../src/utils/ncmpigen/ncmpigen

C_SRCS   = ncmpi_vars_null_stride.c \
           vectors.c \
           collective_error.c \
           test_varm.c \
           alignment_test.c \
           flexible.c \
           nonblocking.c

CXX_SRCS = redef1.cpp

F77_SRCS   = bigrecords.f

PROGS    = $(C_SRCS:.c=)
OBJS     = $(C_SRCS:.c=.o)

ifeq (@has_fortran@, yes)
PROGS   += $(F77_SRCS:.f=)
OBJS    += $(F77_SRCS:.f=.o)
endif

ifeq (@has_mpicxx@, yes)
PROGS   += $(CXX_SRCS:.cpp=)
OBJS    += $(CXX_SRCS:.cpp=.o)
endif

GARBAGE      = $(PROGS) *.nc
PACKING_LIST = $(C_SRCS) $(F77_SRCS) $(CXX_SRCS) Makefile.in depend \
               geopotential.ncdump \
               redef-good.ncdump \
               interop1.sh \
               redef1.sh

all: $(PROGS)

ncmpi_vars_null_stride: ncmpi_vars_null_stride.o $(LIBRARY)
	$(LINK.c) $< $(LDFLAGS) $(LIBS)

vectors: vectors.o $(LIBRARY)
	$(LINK.c) $< $(LDFLAGS) $(LIBS)

bigrecords: bigrecords.o $(LIBRARY)
	$(LINK.f) $< $(LDFLAGS) $(LIBS)

redef1: redef1.o $(LIBRARY)
	$(LINK.cxx) $< $(LDFLAGS) $(LIBS)

collective_error: collective_error.o $(LIBRARY)
	$(LINK.c) $< $(LDFLAGS) $(LIBS)

test_varm: test_varm.o $(LIBRARY)
	$(LINK.c) $< $(LDFLAGS) $(LIBS)

alignment_test: alignment_test.o $(LIBRARY)
	$(LINK.c) $< $(LDFLAGS) $(LIBS)

flexible: flexible.o $(LIBRARY)
	$(LINK.c) $< $(LDFLAGS) $(LIBS)

nonblocking: nonblocking.o $(LIBRARY)
	$(LINK.c) $< $(LDFLAGS) $(LIBS)

testing check: $(PROGS)
	@./ncmpi_vars_null_stride
	@./vectors
	@./test_varm
	@./alignment_test
	@./nonblocking
	@./flexible
ifeq (@has_fortran@, yes)
	@./bigrecords
endif
ifeq (@has_mpicxx@, yes)
	@$(srcdir)/redef1.sh ./redef1 $(srcdir)/redef-good.ncdump
endif

verbose_testing : $(PROGS)
	./ncmpi_vars_null_stride
	./vectors
	./test_varm
	./alignment_test
	./nonblocking
	./flexible
ifeq (@has_fortran@, yes)
	./bigrecords
endif
ifeq (@has_mpicxx@, yes)
	$(srcdir)/redef1.sh ./redef1 $(srcdir)/redef-good.ncdump
endif

# redef1 must be the last one in $(PROGS) for ptest
ptest: $(PROGS)
	@for i in $(PROGS); do ( \
	$(TEST_MPIRUN) -n 4 ./$$i $(TEST_OUT_DIR)/testfile.nc \
	; ) ; done
ifeq (@has_mpicxx@, yes)
	@$(NCMPIGEN) -v 2 -o $(TEST_OUT_DIR)/redef1.nc $(srcdir)/redef-good.ncdump
	@diff --brief $(TEST_OUT_DIR)/testfile.nc $(TEST_OUT_DIR)/redef1.nc
endif

include $(srcdir)/../../rules.make
include $(srcdir)/depend

